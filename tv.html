<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TV Subscription - EasySubscribe</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="logo">
        <h1>EasySubscribe</h1>
      </div>
      <nav class="desktop-nav">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="airtime.html">Airtime</a>
        <a href="data.html">Data</a>
        <a href="electricity.html">Electricity</a>
        <a href="tv.html" class="active">TV</a>
      </nav>
      <div class="mobile-menu-btn">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>
  
  <main class="service-page">
    <div class="container">
      <div class="service-header">
        <div class="service-icon tv-icon"></div>
        <div>
          <h2>TV Subscription</h2>
          <p>Renew your TV subscriptions instantly</p>
        </div>
      </div>
      
      <div class="service-container">
        <div class="service-form-container">
          <div class="form-card">
            <h3>Pay TV Subscription</h3>
            <form id="tvForm">
              <div class="form-group">
                <label for="tv">Select Provider</label>
                <div class="input-with-icon">
                  <i class="fas fa-tv"></i>
                  <select id="tv" required>
                    <option value="">-- Choose Provider --</option>
                    <option value="dstv">DSTV</option>
                    <option value="gotv">GOtv</option>
                    <option value="startimes">StarTimes</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label for="smartcard">Smart Card / IUC Number</label>
                <div class="input-with-icon">
                  <i class="fas fa-id-card"></i>
                  <input type="text" id="smartcard" placeholder="Enter smart card number" required>
                </div>
                <div class="error-message" id="smartcard-error"></div>
              </div>
              
              <div class="form-group">
                <label>Subscription Plan</label>
                <div class="tv-plans" id="dstv-plans" style="display: none;">
                  <!-- Plans will be loaded dynamically from VTU.ng API -->
                  <div class="loading-plans">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Select a provider to view plans</p>
                  </div>
                </div>
                
                <div class="tv-plans" id="gotv-plans" style="display: none;">
                  <!-- Plans will be loaded dynamically from VTU.ng API -->
                  <div class="loading-plans">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Select a provider to view plans</p>
                  </div>
                </div>
                
                <div class="tv-plans" id="startimes-plans" style="display: none;">
                  <!-- Plans will be loaded dynamically from VTU.ng API -->
                  <div class="loading-plans">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Select a provider to view plans</p>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="phone">Phone Number</label>
                <div class="input-with-icon">
                  <i class="fas fa-phone"></i>
                  <input type="tel" id="phone" placeholder="Enter phone number for notification" required>
                </div>
                <div class="error-message" id="phone-error"></div>
              </div>
              
              <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-with-icon">
                  <i class="fas fa-envelope"></i>
                  <input type="email" id="email" placeholder="Enter email for receipt">
                </div>
                <div class="error-message" id="email-error"></div>
              </div>
              
              <div class="form-group">
                <div class="payment-method">
                  <label>Payment Method</label>
                  <div class="payment-options">
                    <div class="payment-option">
                      <input type="radio" id="wallet" name="payment" value="wallet" checked>
                      <label for="wallet">Wallet Balance</label>
                    </div>
                    <div class="payment-option">
                      <input type="radio" id="card" name="payment" value="card">
                      <label for="card">Debit/Credit Card</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <button type="submit" class="btn primary full-width">Subscribe Now</button>
            </form>
          </div>
        </div>
        
        <div class="service-info">
          <div class="info-card">
            <h3>Why Renew TV Subscription With Us?</h3>
            <ul class="benefits-list">
              <li><i class="fas fa-check-circle"></i> Instant activation</li>
              <li><i class="fas fa-check-circle"></i> No convenience fees</li>
              <li><i class="fas fa-check-circle"></i> Automatic renewal reminders</li>
              <li><i class="fas fa-check-circle"></i> Subscription history tracking</li>
              <li><i class="fas fa-check-circle"></i> 24/7 customer support</li>
            </ul>
            
            <div class="faq-section">
              <h4>Frequently Asked Questions</h4>
              <div class="faq-item">
                <div class="faq-question">
                  <p>How long does it take for my subscription to activate?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>TV subscriptions are activated instantly upon successful payment. You'll receive a confirmation message.</p>
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  <p>What happens if I enter the wrong smart card number?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Always double-check your smart card number before payment. If you make a mistake, contact our support team immediately for assistance.</p>
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  <p>Can I pay for someone else's TV subscription?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Yes, simply enter the correct smart card/IUC number and your contact details for notifications and receipts.</p>
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  <p>What is the format for smart card numbers?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>DStv: 10-11 digits, GOtv: 10 digits, StarTimes: 10-12 digits. Our system will validate your entry.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <h2>EasySubscribe</h2>
          <p>Your one-stop solution for bill payments</p>
        </div>
        <div class="footer-links">
          <div class="footer-column">
            <h4>Company</h4>
            <a href="#">About Us</a>
            <a href="#">Careers</a>
            <a href="#">Contact</a>
          </div>
          <div class="footer-column">
            <h4>Services</h4>
            <a href="airtime.html">Airtime</a>
            <a href="data.html">Data</a>
            <a href="electricity.html">Electricity</a>
            <a href="tv.html">TV Subscription</a>
          </div>
          <div class="footer-column">
            <h4>Legal</h4>
            <a href="#">Terms of Service</a>
            <a href="#">Privacy Policy</a>
            <a href="#">FAQ</a>
          </div>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2025 EasySubscribe. All Rights Reserved.</p>
      </div>
    </div>
  </footer>
  
  <!-- Load main.js for all functionality -->
  <script src="main.js"></script>
  
  <!-- Page-specific JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tvForm = document.getElementById('tvForm');
      if (tvForm) {
        // Remove any existing event listeners
        tvForm.removeEventListener('submit', handleTvFormSubmit);
        
        // Add the updated event listener
        tvForm.addEventListener('submit', handleTvFormSubmit);
      }
      
      // Setup smartcard validation
      setupSmartcardValidation();
      
      // Load TV plans when provider changes
      const tvProvider = document.getElementById('tv');
      if (tvProvider) {
        tvProvider.addEventListener('change', function() {
          const provider = this.value;
          if (provider) {
            // Hide all plan sections
            document.getElementById('dstv-plans').style.display = 'none';
            document.getElementById('gotv-plans').style.display = 'none';
            document.getElementById('startimes-plans').style.display = 'none';
            
            // Show selected provider's plans
            document.getElementById(`${provider}-plans`).style.display = 'grid';
            
            // Load plans for the selected provider
            loadTvPlans(provider);
            
            // Validate smartcard if it has a value
            validateSmartcardOnInput();
          }
        });
      }
    });
    
    // Updated TV form submission handler
    function handleTvFormSubmit(e) {
      e.preventDefault();
      
      // Get form data
      const provider = document.getElementById('tv').value;
      const smartcard = document.getElementById('smartcard').value.trim();
      const plan = document.querySelector('input[name="plan"]:checked')?.value;
      const phone = document.getElementById('phone').value.trim();
      const email = document.getElementById('email').value.trim();
      
      // Clear previous errors
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
      
      // Validate form
      let isValid = true;
      
      // Validate provider
      if (!provider) {
        const providerError = document.createElement('div');
        providerError.className = 'error-message';
        providerError.id = 'tv-error';
        providerError.textContent = 'Please select a provider';
        document.getElementById('tv').parentNode.appendChild(providerError);
        isValid = false;
      }
      
      // Validate smartcard
      if (!smartcard) {
        document.getElementById('smartcard-error').textContent = 'Smartcard number is required';
        isValid = false;
      } else if (provider) {
        const validation = validateSmartcardFormat(smartcard, provider);
        if (!validation.valid) {
          document.getElementById('smartcard-error').textContent = validation.message;
          isValid = false;
        }
      }
      
      // Validate plan
      if (!plan) {
        const planError = document.createElement('div');
        planError.className = 'error-message';
        planError.textContent = 'Please select a subscription plan';
        document.querySelector('.tv-plans:visible')?.parentNode.appendChild(planError);
        isValid = false;
      }
      
      // Validate phone
      const phoneRegex = /^(0|234)(7|8|9)[01]\d{8}$/;
      if (!phone) {
        document.getElementById('phone-error').textContent = 'Phone number is required';
        isValid = false;
      } else if (!phoneRegex.test(phone)) {
        document.getElementById('phone-error').textContent = 'Please enter a valid Nigerian phone number';
        isValid = false;
      }
      
      // Validate email (if provided)
      if (email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          document.getElementById('email-error').textContent = 'Please enter a valid email address';
          isValid = false;
        }
      }
      
      if (!isValid) {
        return;
      }
      
      // Store form data in sessionStorage
      const tvData = {
        provider,
        smartcard,
        plan,
        phone,
        email
      };
      
      sessionStorage.setItem('tvData', JSON.stringify(tvData));
      
      // Navigate to confirmation page
      window.location.href = 'tvconfirm.html';
    }
    
    // Setup smartcard validation
    function setupSmartcardValidation() {
      const smartcardInput = document.getElementById('smartcard');
      const tvProvider = document.getElementById('tv');
      
      if (smartcardInput && tvProvider) {
        // Validate on input
        smartcardInput.addEventListener('input', validateSmartcardOnInput);
        
        // Validate on blur (when user leaves the field)
        smartcardInput.addEventListener('blur', validateSmartcardOnBlur);
      }
    }
    
    // Validate smartcard format on input
    function validateSmartcardOnInput() {
      const smartcardInput = document.getElementById('smartcard');
      const tvProvider = document.getElementById('tv');
      const smartcardError = document.getElementById('smartcard-error');
      
      if (!smartcardInput || !tvProvider) return;
      
      const smartcard = smartcardInput.value.trim();
      const provider = tvProvider.value;
      
      // Clear previous validation message
      if (smartcardError) {
        smartcardError.textContent = '';
      }
      
      // Only validate if both fields have values
      if (smartcard && provider) {
        const validation = validateSmartcardFormat(smartcard, provider);
        
        if (!validation.valid) {
          // Show validation error
          if (smartcardError) {
            smartcardError.textContent = validation.message;
          }
          
          // Add visual indication of error
          smartcardInput.classList.add('input-error');
          smartcardInput.classList.remove('input-success');
        } else {
          // Show validation success
          if (smartcardError) {
            smartcardError.textContent = '';
          }
          
          // Add visual indication of success
          smartcardInput.classList.add('input-success');
          smartcardInput.classList.remove('input-error');
        }
      }
    }
    
    // Validate smartcard format on blur
    function validateSmartcardOnBlur() {
      const smartcardInput = document.getElementById('smartcard');
      const tvProvider = document.getElementById('tv');
      const smartcardError = document.getElementById('smartcard-error');
      
      if (!smartcardInput || !tvProvider) return;
      
      const smartcard = smartcardInput.value.trim();
      const provider = tvProvider.value;
      
      // Only validate if smartcard has a value
      if (smartcard) {
        if (!provider) {
          if (smartcardError) {
            smartcardError.textContent = 'Please select a TV provider first';
          }
          smartcardInput.classList.add('input-error');
          smartcardInput.classList.remove('input-success');
          return;
        }
        
        const validation = validateSmartcardFormat(smartcard, provider);
        
        if (!validation.valid) {
          // Show validation error
          if (smartcardError) {
            smartcardError.textContent = validation.message;
          }
          
          // Add visual indication of error
          smartcardInput.classList.add('input-error');
          smartcardInput.classList.remove('input-success');
        } else {
          // Show validation success
          if (smartcardError) {
            smartcardError.textContent = '';
          }
          
          // Add visual indication of success
          smartcardInput.classList.add('input-success');
          smartcardInput.classList.remove('input-error');
        }
      }
    }
    
    // Validate smartcard format based on provider
    function validateSmartcardFormat(smartcard, provider) {
      if (!smartcard || typeof smartcard !== 'string') {
        return { valid: false, message: 'Smartcard number is required' };
      }
      
      // Remove any spaces or dashes
      const cleanCard = smartcard.replace(/[\s-]/g, '');
      
      // Provider-specific validation
      switch (provider.toLowerCase()) {
        case 'dstv':
          if (!/^\d{10,11}$/.test(cleanCard)) {
            return { valid: false, message: 'DStv smartcard must be 10-11 digits' };
          }
          break;
        case 'gotv':
          if (!/^\d{10}$/.test(cleanCard)) {
            return { valid: false, message: 'GOtv smartcard must be 10 digits' };
          }
          break;
        case 'startimes':
          if (!/^\d{10,12}$/.test(cleanCard)) {
            return { valid: false, message: 'StarTimes smartcard must be 10-12 digits' };
          }
          break;
        default:
          // Generic validation for unknown providers
          if (!/^\d{8,15}$/.test(cleanCard)) {
            return { valid: false, message: 'Invalid smartcard number format' };
          }
      }
      
      return { valid: true, message: 'Valid format' };
    }
    
    // Load TV plans from API - UPDATED
    async function loadTvPlans(provider) {
      try {
        const plansContainer = document.getElementById(`${provider}-plans`);
        if (!plansContainer) return;
        
        // Show loading state
        plansContainer.innerHTML = `
          <div class="loading-plans">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading ${provider} plans...</p>
          </div>
        `;
        
        const response = await fetch(`${window.API_BASE || (window.location.hostname === 'localhost' ? 'http://localhost:5001' : 'https://easy-subscribe-backend.onrender.com')}/api/services/tv-variations?provider=${provider}`);
        const data = await response.json();
        
        if (data.success) {
          plansContainer.innerHTML = '';
          
          if (data.data.length === 0) {
            plansContainer.innerHTML = '<p>No plans available for this provider</p>';
            return;
          }
          
          data.data.forEach(plan => {
            const planOption = document.createElement('div');
            planOption.className = 'plan-option';
            planOption.innerHTML = `
              <input type="radio" id="plan-${plan.variation_id}" name="plan" value="${plan.variation_id}" required>
              <label for="plan-${plan.variation_id}">
                <div class="plan-name">${plan.package_bouquet}</div>
                <div class="plan-price">â‚¦${Number(plan.price).toLocaleString()}</div>
              </label>
            `;
            plansContainer.appendChild(planOption);
          });
        } else {
          console.error('Failed to load TV plans:', data.message);
          plansContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>Failed to load TV plans. Please try again later.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading TV plans:', error);
        const plansContainer = document.getElementById(`${provider}-plans`);
        if (plansContainer) {
          plansContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>Failed to load TV plans. Please check your connection.</p>
            </div>
          `;
        }
      }
    }
    
    // Show alert function (duplicate from main.js for standalone functionality)
    function showAlert(message, type = 'error') {
      const alertContainer = document.getElementById('alert-container') || 
                             document.querySelector('.form-card')?.insertAdjacentHTML('afterbegin', 
                               '<div id="alert-container"></div>');
      
      if (!alertContainer) return;
      
      const alertContainerEl = document.getElementById('alert-container');
      alertContainerEl.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
          <span>${message}</span>
          <button class="close-alert">&times;</button>
        </div>
      `;
      
      // Add event listener to close button
      const closeBtn = alertContainerEl.querySelector('.close-alert');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          alertContainerEl.innerHTML = '';
        });
      }
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        alertContainerEl.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>