<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TV Subscription - EasySubscribe</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="logo">
        <h1>EasySubscribe</h1>
      </div>
      <nav class="desktop-nav">
        <a href="index.html">Home</a>
        <a href="dashboard.html">Dashboard</a>
        <a href="airtime.html">Airtime</a>
        <a href="data.html">Data</a>
        <a href="electricity.html">Electricity</a>
        <a href="tv.html" class="active">TV</a>
      </nav>
      <div class="mobile-menu-btn">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>
  
  <main class="service-page">
    <div class="container">
      <div class="service-header">
        <div class="service-icon tv-icon"></div>
        <div>
          <h2>TV Subscription</h2>
          <p>Renew your TV subscriptions instantly</p>
        </div>
      </div>
      
      <div class="service-container">
        <div class="service-form-container">
          <div class="form-card">
            <h3>Pay TV Subscription</h3>
            <form id="tvForm">
              <div class="form-group">
                <label for="tv">Select Provider</label>
                <div class="input-with-icon">
                  <i class="fas fa-tv"></i>
                  <select id="tv" required>
                    <option value="">-- Choose Provider --</option>
                    <option value="dstv">DSTV</option>
                    <option value="gotv">GOtv</option>
                    <option value="startimes">StarTimes</option>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label for="smartcard">Smart Card / IUC Number</label>
                <div class="input-with-icon">
                  <i class="fas fa-id-card"></i>
                  <input type="text" id="smartcard" placeholder="Enter smart card number" required>
                </div>
                <div class="error-message" id="smartcard-error"></div>
              </div>
              
              <!-- Customer Details Section (Initially Hidden) -->
              <div class="form-group customer-details" id="customerDetails" style="display: none;">
                <h4>Customer Details</h4>
                <div class="customer-info">
                  <div class="customer-detail">
                    <span class="detail-label">Name:</span>
                    <span id="customerName">-</span>
                  </div>
                  <div class="customer-detail">
                    <span class="detail-label">Current Plan:</span>
                    <span id="customerPlan">-</span>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label>Subscription Plan</label>
                <div class="tv-plans" id="dstv-plans" style="display: none;">
                  <!-- Plans will be loaded dynamically from API -->
                  <div class="loading-plans">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Select a provider to view plans</p>
                  </div>
                </div>
                
                <div class="tv-plans" id="gotv-plans" style="display: none;">
                  <!-- Plans will be loaded dynamically from API -->
                  <div class="loading-plans">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Select a provider to view plans</p>
                  </div>
                </div>
                
                <div class="tv-plans" id="startimes-plans" style="display: none;">
                  <!-- Plans will be loaded dynamically from API -->
                  <div class="loading-plans">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Select a provider to view plans</p>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="phone">Phone Number</label>
                <div class="input-with-icon">
                  <i class="fas fa-phone"></i>
                  <input type="tel" id="phone" placeholder="Enter phone number for notification" required>
                </div>
                <div class="error-message" id="phone-error"></div>
              </div>
              
              <div class="form-group">
                <label for="email">Email Address</label>
                <div class="input-with-icon">
                  <i class="fas fa-envelope"></i>
                  <input type="email" id="email" placeholder="Enter email for receipt" required>
                </div>
                <div class="error-message" id="email-error"></div>
              </div>
              
              <div class="form-group">
                <div class="payment-method">
                  <label>Payment Method</label>
                  <div class="payment-options">
                    <div class="payment-option">
                      <input type="radio" id="wallet" name="payment" value="wallet" checked>
                      <label for="wallet">Wallet Balance</label>
                    </div>
                    <div class="payment-option">
                      <input type="radio" id="card" name="payment" value="card">
                      <label for="card">Debit/Credit Card</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <button type="submit" class="btn primary full-width">Subscribe Now</button>
            </form>
          </div>
        </div>
        
        <div class="service-info">
          <div class="info-card">
            <h3>Why Renew TV Subscription With Us?</h3>
            <ul class="benefits-list">
              <li><i class="fas fa-check-circle"></i> Instant activation</li>
              <li><i class="fas fa-check-circle"></i> No convenience fees</li>
              <li><i class="fas fa-check-circle"></i> Automatic renewal reminders</li>
              <li><i class="fas fa-check-circle"></i> Subscription history tracking</li>
              <li><i class="fas fa-check-circle"></i> 24/7 customer support</li>
            </ul>
            
            <div class="faq-section">
              <h4>Frequently Asked Questions</h4>
              <div class="faq-item">
                <div class="faq-question">
                  <p>How long does it take for my subscription to activate?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>TV subscriptions are activated instantly upon successful payment. You'll receive a confirmation message.</p>
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  <p>What happens if I enter the wrong smart card number?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Always double-check your smart card number before payment. If you make a mistake, contact our support team immediately for assistance.</p>
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  <p>Can I pay for someone else's TV subscription?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>Yes, simply enter the correct smart card/IUC number and your contact details for notifications and receipts.</p>
                </div>
              </div>
              <div class="faq-item">
                <div class="faq-question">
                  <p>What is the format for smart card numbers?</p>
                  <i class="fas fa-chevron-down"></i>
                </div>
                <div class="faq-answer">
                  <p>DStv: 10-11 digits, GOtv: 10 digits, StarTimes: 10-12 digits. Our system will validate your entry.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-logo">
          <h2>EasySubscribe</h2>
          <p>Your one-stop solution for bill payments</p>
        </div>
        <div class="footer-links">
          <div class="footer-column">
            <h4>Company</h4>
            <a href="#">About Us</a>
            <a href="#">Careers</a>
            <a href="#">Contact</a>
          </div>
          <div class="footer-column">
            <h4>Services</h4>
            <a href="airtime.html">Airtime</a>
            <a href="data.html">Data</a>
            <a href="electricity.html">Electricity</a>
            <a href="tv.html">TV Subscription</a>
          </div>
          <div class="footer-column">
            <h4>Legal</h4>
            <a href="#">Terms of Service</a>
            <a href="#">Privacy Policy</a>
            <a href="#">FAQ</a>
          </div>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2025 EasySubscribe. All Rights Reserved.</p>
      </div>
    </div>
  </footer>
  
  <!-- Load main.js for all functionality -->
  <script src="main.js"></script>
  
  <!-- Page-specific JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize TV page functionality
      initializeTvPage();
      
      // Setup FAQ toggle
      setupFaqToggle();
    });
    
    // Initialize TV page
    function initializeTvPage() {
      // Setup provider change listener
      const tvProvider = document.getElementById('tv');
      if (tvProvider) {
        tvProvider.addEventListener('change', function() {
          const provider = this.value;
          if (provider) {
            // Hide all plan sections
            document.getElementById('dstv-plans').style.display = 'none';
            document.getElementById('gotv-plans').style.display = 'none';
            document.getElementById('startimes-plans').style.display = 'none';
            
            // Show selected provider's plans
            document.getElementById(`${provider}-plans`).style.display = 'grid';
            
            // Load plans for the selected provider
            loadTvPlans(provider);
            
            // Validate smartcard if it has a value
            if (typeof validateSmartcardOnInput === 'function') {
              validateSmartcardOnInput();
            }
          }
        });
      }
      
      // Setup smartcard input listener for customer details
      const smartcardInput = document.getElementById('smartcard');
      if (smartcardInput) {
        // Use debounce to avoid too many API calls
        let debounceTimer;
        
        smartcardInput.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            // Use the function from main.js if available
            if (typeof loadCustomerDetails === 'function') {
              loadCustomerDetails();
            }
          }, 500); // Wait 500ms after user stops typing
        });
        
        smartcardInput.addEventListener('blur', function() {
          // Use the function from main.js if available
          if (typeof loadCustomerDetails === 'function') {
            loadCustomerDetails();
          }
        });
      }
    }
    
    // Setup FAQ toggle for this page
    function setupFaqToggle() {
      const faqQuestions = document.querySelectorAll('.faq-question');
      
      faqQuestions.forEach(question => {
        question.addEventListener('click', () => {
          const answer = question.nextElementSibling;
          const icon = question.querySelector('i');
          
          answer.classList.toggle('active');
          icon.classList.toggle('fa-chevron-down');
          icon.classList.toggle('fa-chevron-up');
        });
      });
    }
    
    // Load TV plans from API
    async function loadTvPlans(provider) {
      try {
        const plansContainer = document.getElementById(`${provider}-plans`);
        if (!plansContainer) return;
        
        // Show loading state
        plansContainer.innerHTML = `
          <div class="loading-plans">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading ${provider} plans...</p>
          </div>
        `;
        
        // Use the global API_BASE if available, otherwise construct it
        const apiUrl = typeof API_BASE !== 'undefined' ? API_BASE : 
          (window.location.hostname === 'localhost' ? 'http://localhost:5001' : 'https://easy-subscribe-backend.onrender.com');
        
        console.log(`Fetching TV plans from: ${apiUrl}/api/services/tv-variations?provider=${provider}`);
        
        const response = await fetch(`${apiUrl}/api/services/tv-variations?provider=${provider}`);
        
        // Check if response is OK
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('TV plans response:', data);
        
        if (data.success) {
          plansContainer.innerHTML = '';
          
          if (data.data.length === 0) {
            plansContainer.innerHTML = '<p>No plans available for this provider</p>';
            return;
          }
          
          data.data.forEach(plan => {
            const planOption = document.createElement('div');
            planOption.className = 'plan-option';
            planOption.innerHTML = `
              <input type="radio" id="plan-${plan.variation_id}" name="plan" value="${plan.variation_id}" required>
              <label for="plan-${plan.variation_id}">
                <div class="plan-name">${plan.package_bouquet}</div>
                <div class="plan-price">â‚¦${Number(plan.price).toLocaleString()}</div>
              </label>
            `;
            plansContainer.appendChild(planOption);
          });
        } else {
          console.error('Failed to load TV plans:', data.message);
          plansContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>Failed to load TV plans: ${data.message || 'Unknown error'}</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading TV plans:', error);
        const plansContainer = document.getElementById(`${provider}-plans`);
        if (plansContainer) {
          plansContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <p>Failed to load TV plans: ${error.message || 'Please check your connection.'}</p>
              <p class="error-debug">Debug: Check browser console for more details</p>
            </div>
          `;
        }
      }
    }
  </script>
</body>
</html>